<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥åº™å‡ºå£ - å¯»å®å¤§å†’é™©</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="scene-page exit">
    <div class="container">
        <div class="scene-header">
            <h1>ğŸšª ç¥åº™å‡ºå£</h1>
            <button class="back-btn" onclick="window.location.href='index.html'">è¿”å›åœ°å›¾</button>
        </div>
        
        <div class="status-panel">
            <p>é‡‘å¸: <span id="gold">50</span> | æ‰“æ‰‹: <span id="helpers">0</span>äºº | å®è—: <span id="treasure">æœªæ‰¾åˆ°</span></p>
            <button class="music-toggle" onclick="toggleMusic()">ğŸµ éŸ³ä¹ï¼šå¼€å¯</button>
        </div>
        
        <div class="scene-content">
            <p class="description">ç»ˆäºåˆ°è¾¾å‡ºå£ï¼ä½†æ‰“æ‰‹ä»¬è¦æ±‚æ”¯ä»˜å°¾æ¬¾æ‰èƒ½å¸®ä½ å¸¦èµ°å®è—...</p>
            
            <div class="actions">
                <button onclick="payHelpers()">æ”¯ä»˜å°¾æ¬¾ï¼ˆ8é‡‘å¸/äººï¼‰</button>
                <button onclick="endAdventure()">ç»“æŸå†’é™©</button>
            </div>
            
            <div class="log-container">
                <h3>ç»“ç®—æ—¥å¿—</h3>
                <div class="log" id="log"></div>
            </div>
        </div>
    </div>

    <!-- å‡ºå£èƒŒæ™¯éŸ³ä¹ï¼ˆèƒœåˆ©åº†ç¥é£æ ¼ï¼‰ -->
    <audio id="bg-music" loop>
        <source src="https://mixkit.co/music/preview/mixkit-video-game-win-2019.mp3" type="audio/mpeg">
    

    <script src="js/game.js"></script>
    <script>
        const gameState = loadGameState();
        updateUI();
        
        // æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°å®è—
        if (!gameState.hasTreasure) {
            addLog('è¿˜æ²¡æ‰¾åˆ°å®è—ï¼Œæ— æ³•ç»“ç®—ï¼', 'error');
            document.querySelector('button[onclick="payHelpers()"]').disabled = true;
            document.querySelector('button[onclick="endAdventure()"]').disabled = true;
        } else {
            addLog('ä½ å¸¦ç€å®è—æ¥åˆ°å‡ºå£ï¼Œæ‰“æ‰‹ä»¬åœ¨ç­‰å¾…ç»“ç®—...', 'info');
        }
        
        // æ›´æ–°å®è—æ˜¾ç¤º
        document.querySelectorAll('#treasure').forEach(el => {
            el.textContent = gameState.hasTreasure ? 'å·²æ‰¾åˆ°' : 'æœªæ‰¾åˆ°';
        });

        // éŸ³ä¹åˆå§‹åŒ–
        const music = document.getElementById('bg-music');
        music.volume = 0.2;
        updateMusicButton();

        // é¦–æ¬¡ç‚¹å‡»æ’­æ”¾éŸ³ä¹
        document.body.addEventListener('click', playMusicOnFirstClick, { once: true });

        // éŸ³ä¹æ§åˆ¶å‡½æ•°
        function playMusicOnFirstClick() {
            if (gameState.musicEnabled && music.paused) {
                music.play().catch(e => console.log('éŸ³ä¹éœ€ç‚¹å‡»åæ’­æ”¾'));
            }
        }

        function toggleMusic() {
            gameState.musicEnabled = !gameState.musicEnabled;
            if (gameState.musicEnabled) {
                music.play();
            } else {
                music.pause();
            }
            updateMusicButton();
            saveGameState();
        }

        function updateMusicButton() {
            const btn = document.querySelector('.music-toggle');
            btn.textContent = gameState.musicEnabled ? 'ğŸµ éŸ³ä¹ï¼šå¼€å¯' : 'ğŸµ éŸ³ä¹ï¼šå…³é—­';
        }

        // åŸæœ‰æ¸¸æˆé€»è¾‘
        async function payHelpers() {
            if (gameState.sceneCompleted.exit) {
                addLog('å†’é™©å·²å®Œæˆï¼Œæ„Ÿè°¢å‚ä¸ï¼', 'info');
                return;
            }
            
            const needGold = gameState.helpers * 8;
            addLog(`æ‰“æ‰‹ä»¬è¦æ±‚æ”¯ä»˜å°¾æ¬¾ï¼š${needGold}é‡‘å¸ï¼ˆ${gameState.helpers}äººÃ—8ï¼‰`, 'info');
            await delay(1000);
            
            if (gameState.gold >= needGold) {
                gameState.gold -= needGold;
                gameState.sceneCompleted.exit = true;
                addLog(`æ”¯ä»˜æˆåŠŸï¼æœ€ç»ˆå‰©ä½™é‡‘å¸ï¼š${gameState.gold}ï¼ŒæˆåŠŸå¸¦èµ°å®è—ï¼`, 'success');
                addLog('ğŸ† æ­å–œå®Œæˆæ‰€æœ‰å†’é™©ï¼', 'success');
            } else {
                addLog(`é‡‘å¸ä¸è¶³ï¼ˆéœ€è¦${needGold}ï¼Œåªæœ‰${gameState.gold}ï¼‰ï¼Œæ‰“æ‰‹æŠ¢èµ°äº†å®è—...`, 'error');
                gameState.sceneCompleted.exit = true;
            }
            saveGameState();
            updateUI();
        }
        
        function endAdventure() {
            if (gameState.sceneCompleted.exit) {
                window.location.href = 'index.html';
            } else {
                addLog('è¯·å…ˆæ”¯ä»˜å°¾æ¬¾', 'warning');
            }
        }
    </script>
</body>
</html>
