<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥ç§˜ç¥åº™ - å¯»å®å¤§å†’é™©</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="scene-page temple">
    <div class="container">
        <div class="scene-header">
            <h1>ğŸ›ï¸ ç¥ç§˜ç¥åº™</h1>
            <button class="back-btn" onclick="window.location.href='index.html'">è¿”å›åœ°å›¾</button>
        </div>
        
        <div class="status-panel">
            <p>é‡‘å¸: <span id="gold">50</span> | æ‰“æ‰‹: <span id="helpers">0</span>äºº | å®è—: <span id="treasure">æœªæ‰¾åˆ°</span></p>
        </div>
        
        <div class="scene-content">
            <p class="description">ç¥åº™å…¥å£é˜´æ£®å¹½æš—ï¼Œé—¨å£æœ‰å®ˆå«æŠŠå®ˆï¼Œæ·±å¤„ä¼¼ä¹è—ç€ä¼ è¯´ä¸­çš„å®è—...</p>
            
            <div class="actions">
                <button onclick="fightGuard()">å¯¹æŠ—å®ˆå«ï¼ˆéœ€3+æ‰“æ‰‹ï¼‰</button>
                <button onclick="searchTreasure()" disabled>æœç´¢å®è—</button>
            </div>
            
            <div class="log-container">
                <h3>ç¥åº™æ—¥å¿—</h3>
                <div class="log" id="log"></div>
            </div>
        </div>
    </div>

    <!-- ç¥åº™èƒŒæ™¯éŸ³ä¹ -->
    <audio id="bg-music" loop>
        <source src="audio/temple.mp3" type="audio/mpeg">
    </audio>

    <script src="js/game.js"></script>
    <script>
        const gameState = loadGameState();
        updateUI();
        
        // æ£€æŸ¥å‰ç½®æ¡ä»¶ï¼ˆè‡³å°‘3åæ‰“æ‰‹ï¼‰
        if (gameState.helpers < 3) {
            addLog('æç¤ºï¼šè‡³å°‘éœ€è¦3åæ‰“æ‰‹æ‰èƒ½å¯¹æŠ—å®ˆå«ï¼', 'error');
            document.querySelector('button[onclick="fightGuard()"]').disabled = true;
        } else {
            addLog('ä½ å¸¦ç€æ‰“æ‰‹æ¥åˆ°ç¥åº™é—¨å£ï¼Œå®ˆå«æ‹¦ä½äº†å»è·¯...', 'info');
        }
        
        // æ›´æ–°å®è—æ˜¾ç¤º
        document.querySelectorAll('#treasure').forEach(el => {
            el.textContent = gameState.hasTreasure ? 'å·²æ‰¾åˆ°' : 'æœªæ‰¾åˆ°';
        });
        
        // å¯¹æŠ—å®ˆå«
        async function fightGuard() {
            addLog('æŒ‡æŒ¥æ‰“æ‰‹å¯¹æŠ—å®ˆå«ï¼', 'info');
            await delay(2000);
            
            // æˆåŠŸç‡ = æ‰“æ‰‹æ•° Ã— 20%ï¼ˆ3äºº60%ï¼Œ4äºº80%ï¼Œ5äººä»¥ä¸Š100%ï¼‰
            const successRate = Math.min(gameState.helpers * 0.2, 1);
            if (Math.random() < successRate) {
                addLog('æˆåŠŸå‡»é€€å®ˆå«ï¼å¯ä»¥è¿›å…¥ç¥åº™å†…éƒ¨äº†', 'success');
                document.querySelector('button[onclick="searchTreasure()"]').disabled = false;
            } else {
                addLog('å®ˆå«å¤ªå¼ºï¼Œè¢«è¿«æ’¤é€€ï¼ŒæŸå¤±1åæ‰“æ‰‹', 'error');
                gameState.helpers = Math.max(0, gameState.helpers - 1);
                saveGameState();
                updateUI();
            }
        }
        
        // æœç´¢å®è—ï¼ˆè§£é”å‡ºå£ï¼‰
        async function searchTreasure() {
            if (gameState.hasTreasure) {
                addLog('å·²ç»æ‰¾åˆ°å®è—ï¼Œå»å‡ºå£ç»“ç®—å§ï¼', 'info');
                return;
            }
            
            addLog('åœ¨ç¥åº™æ·±å¤„æœç´¢å®è—...', 'info');
            await delay(2500);
            
            // æ‰¾åˆ°å®è—æ¦‚ç‡ = æ‰“æ‰‹æ•° Ã— 15%ï¼ˆ3äºº45%ï¼Œ4äºº60%...ï¼‰
            const findRate = Math.min(gameState.helpers * 0.15, 0.8);
            if (Math.random() < findRate) {
                gameState.hasTreasure = true;
                gameState.sceneCompleted.temple = true;
                gameState.scenes.exit = true; // è§£é”å‡ºå£
                addLog('ğŸ‰ æ‰¾åˆ°é»„é‡‘å®è—ï¼ç¥åº™å‡ºå£å·²è§£é”', 'success');
                document.querySelectorAll('#treasure').forEach(el => {
                    el.textContent = 'å·²æ‰¾åˆ°';
                });
            } else {
                addLog('æ²¡æ‰¾åˆ°å®è—ï¼Œå†è¯•ä¸€æ¬¡...', 'warning');
            }
            saveGameState();
            updateUI();
        }
        
        // æ’­æ”¾éŸ³ä¹
        const music = document.getElementById('bg-music');
        if (gameState.musicEnabled) {
            music.volume = 0.3;
            document.body.addEventListener('click', () => {
                music.play().catch(e => console.log('éœ€ç‚¹å‡»é¡µé¢åæ’­æ”¾éŸ³ä¹'));
            }, { once: true });
        }
    </script>
</body>
</html>